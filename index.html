<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>Book Scanner</title>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/html5-qrcode/2.3.8/html5-qrcode.min.js" integrity="sha512-r6rDA7W6ZeQhvl8S7yRVQUKVHdexq+GAlNkNNqVC7YyIV+NwqCTJe2hDWCiffTyRNOeGEzRRJ9ifvRm/HCzGYg==" crossorigin="anonymous" referrerpolicy="no-referrer"></script>
    <style>
        * {
            box-sizing: border-box;
            margin: 0;
            padding: 0;
        }
        
        :root {
            --purple-dark: #1a1625;
            --purple-mid: #2d2640;
            --purple-light: #4a3f6b;
            --purple-accent: #9d8cd6;
            --purple-bright: #b8a9e8;
            --success: #68d391;
            --warning: #f6ad55;
        }
        
        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
            background: linear-gradient(180deg, var(--purple-dark) 0%, #0d0a12 100%);
            color: #e0e0e0;
            min-height: 100vh;
            padding: 20px;
            padding-bottom: 100px;
        }
        
        header {
            text-align: center;
            margin-bottom: 24px;
        }
        
        h1 {
            font-size: 24px;
            font-weight: 300;
            color: var(--purple-bright);
            letter-spacing: 1px;
        }
        
        .subtitle {
            font-size: 12px;
            color: #888;
            margin-top: 4px;
        }
        
        /* Scanner Section */
        .scanner-container {
            background: var(--purple-mid);
            border-radius: 16px;
            overflow: hidden;
            margin-bottom: 20px;
        }
        
        #reader {
            width: 100%;
        }
        
        #reader video {
            border-radius: 16px 16px 0 0;
        }
        
        .scanner-status {
            padding: 12px;
            text-align: center;
            font-size: 14px;
            color: var(--purple-accent);
        }
        
        /* Manual Entry */
        .manual-entry {
            background: var(--purple-mid);
            border-radius: 12px;
            padding: 16px;
            margin-bottom: 20px;
        }
        
        .manual-entry input {
            width: 100%;
            padding: 12px;
            background: rgba(255,255,255,0.08);
            border: 1px solid rgba(255,255,255,0.15);
            border-radius: 8px;
            color: #fff;
            font-size: 16px;
            margin-bottom: 10px;
        }
        
        .manual-entry input::placeholder {
            color: #666;
        }
        
        .btn {
            padding: 12px 24px;
            border: none;
            border-radius: 8px;
            font-size: 14px;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.2s;
            width: 100%;
        }
        
        .btn-primary {
            background: linear-gradient(135deg, var(--purple-accent), var(--purple-light));
            color: white;
        }
        
        .btn-success {
            background: linear-gradient(135deg, #48bb78, #38a169);
            color: white;
        }
        
        .btn-secondary {
            background: rgba(255,255,255,0.1);
            color: #ccc;
        }
        
        /* Book Preview */
        .book-preview {
            background: var(--purple-mid);
            border-radius: 16px;
            padding: 20px;
            margin-bottom: 20px;
            display: none;
        }
        
        .book-preview.active {
            display: block;
        }
        
        .book-preview-header {
            display: flex;
            gap: 16px;
            margin-bottom: 16px;
        }
        
        .book-cover-preview {
            width: 80px;
            height: 120px;
            background: var(--purple-light);
            border-radius: 4px;
            overflow: hidden;
            flex-shrink: 0;
        }
        
        .book-cover-preview img {
            width: 100%;
            height: 100%;
            object-fit: cover;
        }
        
        .book-info h3 {
            font-size: 18px;
            color: #fff;
            margin-bottom: 4px;
            line-height: 1.3;
        }
        
        .book-info .author {
            color: var(--purple-accent);
            font-size: 14px;
            margin-bottom: 8px;
        }
        
        .book-info .meta {
            font-size: 12px;
            color: #888;
        }
        
        /* Rating */
        .rating-section {
            margin-bottom: 16px;
        }
        
        .rating-section label {
            display: block;
            font-size: 12px;
            color: #888;
            margin-bottom: 8px;
            text-transform: uppercase;
            letter-spacing: 1px;
        }
        
        .star-rating {
            display: flex;
            gap: 8px;
        }
        
        .star {
            font-size: 28px;
            cursor: pointer;
            transition: all 0.15s;
            color: #444;
        }
        
        .star.active {
            color: #ffd700;
        }
        
        .star:hover {
            transform: scale(1.2);
        }
        
        /* Status */
        .status-section {
            margin-bottom: 20px;
        }
        
        .status-buttons {
            display: flex;
            gap: 8px;
        }
        
        .status-btn {
            flex: 1;
            padding: 10px;
            background: rgba(255,255,255,0.08);
            border: 2px solid transparent;
            border-radius: 8px;
            color: #aaa;
            font-size: 12px;
            cursor: pointer;
            text-align: center;
            transition: all 0.2s;
        }
        
        .status-btn.active {
            border-color: var(--purple-accent);
            color: var(--purple-bright);
            background: rgba(157, 140, 214, 0.15);
        }
        
        .status-btn .icon {
            font-size: 20px;
            display: block;
            margin-bottom: 4px;
        }
        
        /* Scanned Books List */
        .scanned-list {
            background: var(--purple-mid);
            border-radius: 16px;
            padding: 16px;
            margin-bottom: 20px;
        }
        
        .scanned-list h2 {
            font-size: 14px;
            color: var(--purple-accent);
            margin-bottom: 12px;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }
        
        .scanned-count {
            background: var(--purple-light);
            padding: 4px 10px;
            border-radius: 12px;
            font-size: 12px;
        }
        
        .scanned-book {
            display: flex;
            align-items: center;
            gap: 12px;
            padding: 10px 0;
            border-bottom: 1px solid rgba(255,255,255,0.06);
        }
        
        .scanned-book:last-child {
            border-bottom: none;
        }
        
        .scanned-book-cover {
            width: 40px;
            height: 60px;
            background: var(--purple-light);
            border-radius: 3px;
            overflow: hidden;
        }
        
        .scanned-book-cover img {
            width: 100%;
            height: 100%;
            object-fit: cover;
        }
        
        .scanned-book-info {
            flex: 1;
            min-width: 0;
        }
        
        .scanned-book-info .title {
            font-size: 14px;
            color: #fff;
            white-space: nowrap;
            overflow: hidden;
            text-overflow: ellipsis;
        }
        
        .scanned-book-info .author {
            font-size: 12px;
            color: #888;
        }
        
        .scanned-book-status {
            font-size: 18px;
        }
        
        .remove-btn {
            background: none;
            border: none;
            color: #666;
            font-size: 18px;
            cursor: pointer;
            padding: 4px;
        }
        
        .export-single-btn {
            background: rgba(72, 187, 120, 0.2);
            border: none;
            color: #68d391;
            font-size: 16px;
            cursor: pointer;
            padding: 8px;
            border-radius: 6px;
        }
        
        .export-single-btn:active {
            background: rgba(72, 187, 120, 0.4);
        }
        
        /* Export Section */
        .export-section {
            position: fixed;
            bottom: 0;
            left: 0;
            right: 0;
            background: linear-gradient(0deg, var(--purple-dark) 80%, transparent);
            padding: 20px;
            padding-top: 40px;
        }
        
        .export-buttons {
            display: flex;
            gap: 10px;
        }
        
        .export-buttons .btn {
            flex: 1;
        }
        
        /* Loading */
        .loading {
            text-align: center;
            padding: 20px;
            color: var(--purple-accent);
        }
        
        .loading::after {
            content: '';
            animation: dots 1.5s infinite;
        }
        
        @keyframes dots {
            0%, 20% { content: '.'; }
            40% { content: '..'; }
            60%, 100% { content: '...'; }
        }
        
        /* Empty state */
        .empty-state {
            text-align: center;
            padding: 30px;
            color: #666;
        }
        
        .empty-state .icon {
            font-size: 48px;
            margin-bottom: 12px;
        }
        
        /* Tabs */
        .tabs {
            display: flex;
            gap: 8px;
            margin-bottom: 16px;
        }
        
        .tab {
            flex: 1;
            padding: 10px;
            background: rgba(255,255,255,0.05);
            border: none;
            border-radius: 8px;
            color: #888;
            font-size: 13px;
            cursor: pointer;
            transition: all 0.2s;
        }
        
        .tab.active {
            background: var(--purple-light);
            color: #fff;
        }
        
        .tab-content {
            display: none;
        }
        
        .tab-content.active {
            display: block;
        }
        
        /* Notes input */
        .notes-section textarea {
            width: 100%;
            height: 80px;
            padding: 12px;
            background: rgba(255,255,255,0.08);
            border: 1px solid rgba(255,255,255,0.15);
            border-radius: 8px;
            color: #fff;
            font-size: 14px;
            resize: none;
            font-family: inherit;
        }
        
        .notes-section label {
            display: block;
            font-size: 12px;
            color: #888;
            margin-bottom: 8px;
            text-transform: uppercase;
            letter-spacing: 1px;
        }
    </style>
</head>
<body>
    <header>
        <h1>üìö Book Scanner</h1>
        <p class="subtitle">Scan ISBN ‚Üí Export to Obsidian</p>
    </header>
    
    <!-- Tabs -->
    <div class="tabs">
        <button class="tab active" data-tab="scan">üì∑ Scan</button>
        <button class="tab" data-tab="manual">‚úèÔ∏è Manual</button>
        <button class="tab" data-tab="list">üìã List <span id="list-count"></span></button>
    </div>
    
    <!-- Scan Tab -->
    <div class="tab-content active" id="tab-scan">
        <div class="scanner-container">
            <div id="reader"></div>
            <div class="scanner-status" id="scanner-status">Initializing camera...</div>
        </div>
    </div>
    
    <!-- Manual Tab -->
    <div class="tab-content" id="tab-manual">
        <div class="manual-entry">
            <input type="text" id="manual-isbn" placeholder="Enter ISBN (e.g., 9780374275631)" inputmode="numeric">
            <button class="btn btn-primary" onclick="lookupManualISBN()">Look Up Book</button>
            <p style="text-align: center; margin-top: 12px; font-size: 12px; color: #666;">
                Or enter details manually:
            </p>
            <input type="text" id="manual-title" placeholder="Title" style="margin-top: 12px;">
            <input type="text" id="manual-author" placeholder="Author">
            <button class="btn btn-secondary" onclick="addManualBook()">Add Without ISBN</button>
        </div>
    </div>
    
    <!-- List Tab -->
    <div class="tab-content" id="tab-list">
        <div class="scanned-list">
            <h2>
                Scanned Books
                <span class="scanned-count" id="scanned-count">0</span>
            </h2>
            <div id="scanned-books-list">
                <div class="empty-state">
                    <div class="icon">üìö</div>
                    <p>No books scanned yet.<br>Start scanning to build your list!</p>
                </div>
            </div>
        </div>
    </div>
    
    <!-- Book Preview (appears after scan) -->
    <div class="book-preview" id="book-preview">
        <div class="book-preview-header">
            <div class="book-cover-preview">
                <img id="preview-cover" src="" alt="">
            </div>
            <div class="book-info">
                <h3 id="preview-title">Book Title</h3>
                <p class="author" id="preview-author">Author Name</p>
                <p class="meta" id="preview-meta">ISBN ‚Ä¢ Pages</p>
            </div>
        </div>
        
        <div class="rating-section">
            <label>Rating</label>
            <div class="star-rating" id="star-rating">
                <span class="star" data-rating="1">‚òÖ</span>
                <span class="star" data-rating="2">‚òÖ</span>
                <span class="star" data-rating="3">‚òÖ</span>
                <span class="star" data-rating="4">‚òÖ</span>
                <span class="star" data-rating="5">‚òÖ</span>
            </div>
        </div>
        
        <div class="status-section">
            <label>Status</label>
            <div class="status-buttons">
                <button class="status-btn active" data-status="to-read">
                    <span class="icon">üìö</span>
                    To Read
                </button>
                <button class="status-btn" data-status="reading">
                    <span class="icon">üìñ</span>
                    Reading
                </button>
                <button class="status-btn" data-status="finished">
                    <span class="icon">‚úì</span>
                    Finished
                </button>
            </div>
        </div>
        
        <div class="notes-section">
            <label>Notes (optional)</label>
            <textarea id="preview-notes" placeholder="Any initial thoughts..."></textarea>
        </div>
        
        <div style="display: flex; gap: 10px; margin-top: 16px;">
            <button class="btn btn-secondary" onclick="cancelPreview()" style="flex: 1;">Cancel</button>
            <button class="btn btn-success" onclick="confirmBook()" style="flex: 2;">Add to List</button>
        </div>
    </div>
    
    <!-- Export Section -->
    <div class="export-section" id="export-section" style="display: none;">
        <div class="export-buttons">
            <button class="btn btn-secondary" onclick="clearAll()">Clear All</button>
            <button class="btn btn-primary" onclick="exportToObsidian()">Export to Obsidian</button>
        </div>
    </div>

    <script>
        // State
        let scannedBooks = JSON.parse(localStorage.getItem('scannedBooks') || '[]');
        let currentBook = null;
        let currentRating = 0;
        let currentStatus = 'to-read';
        let html5QrCode = null;
        
        // Initialize
        document.addEventListener('DOMContentLoaded', () => {
            // Check if library loaded
            if (typeof Html5Qrcode === 'undefined') {
                document.getElementById('scanner-status').innerHTML = 
                    '‚ùå Scanner library failed to load.<br><small>Try refreshing the page or use Manual entry tab.</small>';
                return;
            }
            
            initScanner();
            renderScannedList();
            setupEventListeners();
        });
        
        function initScanner() {
            try {
                html5QrCode = new Html5Qrcode("reader");
                
                Html5Qrcode.getCameras().then(cameras => {
                    if (cameras && cameras.length) {
                        // Prefer back camera
                        const backCamera = cameras.find(c => c.label.toLowerCase().includes('back')) || cameras[0];
                        
                        html5QrCode.start(
                            backCamera.id,
                            {
                                fps: 10,
                                qrbox: { width: 250, height: 150 },
                                aspectRatio: 1.0
                            },
                            onScanSuccess,
                            onScanFailure
                        ).then(() => {
                            document.getElementById('scanner-status').textContent = 'Point camera at ISBN barcode';
                        }).catch(err => {
                            document.getElementById('scanner-status').innerHTML = 
                                '‚ùå Camera error: ' + err + '<br><small>Try the Manual entry tab instead.</small>';
                        });
                    } else {
                        document.getElementById('scanner-status').innerHTML = 
                            'üì∑ No camera found.<br><small>Use the Manual entry tab to add books.</small>';
                    }
                }).catch(err => {
                    document.getElementById('scanner-status').innerHTML = 
                        '‚ùå Camera access denied.<br><small>Allow camera permissions or use Manual entry.</small>';
                });
            } catch (err) {
                document.getElementById('scanner-status').innerHTML = 
                    '‚ùå Scanner error: ' + err + '<br><small>Use the Manual entry tab.</small>';
            }
        }
        
        function onScanSuccess(decodedText, decodedResult) {
            // Validate ISBN format (10 or 13 digits)
            const cleaned = decodedText.replace(/[^0-9X]/gi, '');
            if (cleaned.length === 10 || cleaned.length === 13) {
                // Vibrate for feedback
                if (navigator.vibrate) navigator.vibrate(100);
                
                // Pause scanner
                html5QrCode.pause();
                document.getElementById('scanner-status').textContent = 'Found: ' + cleaned;
                
                // Look up book
                lookupISBN(cleaned);
            }
        }
        
        function onScanFailure(error) {
            // Ignore - continuous scanning
        }
        
        async function lookupISBN(isbn) {
            document.getElementById('scanner-status').innerHTML = '<span class="loading">Looking up book</span>';
            
            try {
                // Try Google Books API
                const response = await fetch(`https://www.googleapis.com/books/v1/volumes?q=isbn:${isbn}`);
                const data = await response.json();
                
                if (data.items && data.items.length > 0) {
                    const book = data.items[0].volumeInfo;
                    
                    currentBook = {
                        title: book.title || 'Unknown Title',
                        author: (book.authors || ['Unknown Author']).join(', '),
                        isbn: isbn,
                        pages: book.pageCount || null,
                        publisher: book.publisher || null,
                        published: book.publishedDate || null,
                        description: book.description || null,
                        categories: book.categories || [],
                        cover: book.imageLinks?.thumbnail?.replace('http:', 'https:') || null,
                        format: 'physical',
                        rating: 0,
                        status: 'to-read',
                        notes: '',
                        date_added: new Date().toISOString().split('T')[0]
                    };
                    
                    showBookPreview(currentBook);
                } else {
                    document.getElementById('scanner-status').textContent = 'Book not found. Try manual entry.';
                    html5QrCode.resume();
                }
            } catch (error) {
                document.getElementById('scanner-status').textContent = 'Lookup failed. Try again.';
                html5QrCode.resume();
            }
        }
        
        function lookupManualISBN() {
            const isbn = document.getElementById('manual-isbn').value.replace(/[^0-9X]/gi, '');
            if (isbn.length === 10 || isbn.length === 13) {
                lookupISBN(isbn);
            } else {
                alert('Please enter a valid 10 or 13 digit ISBN');
            }
        }
        
        function addManualBook() {
            const title = document.getElementById('manual-title').value.trim();
            const author = document.getElementById('manual-author').value.trim();
            
            if (!title) {
                alert('Please enter at least a title');
                return;
            }
            
            currentBook = {
                title: title,
                author: author || 'Unknown Author',
                isbn: null,
                pages: null,
                publisher: null,
                published: null,
                description: null,
                categories: [],
                cover: null,
                format: 'physical',
                rating: 0,
                status: 'to-read',
                notes: '',
                date_added: new Date().toISOString().split('T')[0]
            };
            
            showBookPreview(currentBook);
            
            // Clear inputs
            document.getElementById('manual-title').value = '';
            document.getElementById('manual-author').value = '';
        }
        
        function showBookPreview(book) {
            document.getElementById('preview-title').textContent = book.title;
            document.getElementById('preview-author').textContent = book.author;
            
            let meta = [];
            if (book.isbn) meta.push('ISBN: ' + book.isbn);
            if (book.pages) meta.push(book.pages + ' pages');
            document.getElementById('preview-meta').textContent = meta.join(' ‚Ä¢ ') || '';
            
            const coverImg = document.getElementById('preview-cover');
            if (book.cover) {
                coverImg.src = book.cover;
                coverImg.style.display = 'block';
            } else {
                coverImg.style.display = 'none';
            }
            
            // Reset rating and status
            currentRating = 0;
            currentStatus = 'to-read';
            updateStars();
            updateStatusButtons();
            document.getElementById('preview-notes').value = '';
            
            document.getElementById('book-preview').classList.add('active');
            
            // Switch to scan tab to show preview
            switchTab('scan');
        }
        
        function cancelPreview() {
            document.getElementById('book-preview').classList.remove('active');
            currentBook = null;
            if (html5QrCode) {
                html5QrCode.resume();
                document.getElementById('scanner-status').textContent = 'Point camera at ISBN barcode';
            }
        }
        
        function confirmBook() {
            if (!currentBook) return;
            
            currentBook.rating = currentRating;
            currentBook.status = currentStatus;
            currentBook.notes = document.getElementById('preview-notes').value.trim();
            
            // Check for duplicates
            const isDuplicate = scannedBooks.some(b => 
                (b.isbn && b.isbn === currentBook.isbn) || 
                (b.title.toLowerCase() === currentBook.title.toLowerCase() && 
                 b.author.toLowerCase() === currentBook.author.toLowerCase())
            );
            
            if (isDuplicate) {
                if (!confirm('This book appears to be already in your list. Add anyway?')) {
                    cancelPreview();
                    return;
                }
            }
            
            scannedBooks.push(currentBook);
            saveBooks();
            renderScannedList();
            
            const bookIndex = scannedBooks.length - 1;
            
            document.getElementById('book-preview').classList.remove('active');
            
            // Offer to export immediately
            if (confirm(`‚úÖ Added "${currentBook.title}"\n\nExport to Obsidian now?`)) {
                exportSingleBook(bookIndex);
            }
            
            currentBook = null;
            
            if (html5QrCode) {
                html5QrCode.resume();
                document.getElementById('scanner-status').textContent = 'Scan next book...';
            }
        }
        
        function setupEventListeners() {
            // Tabs
            document.querySelectorAll('.tab').forEach(tab => {
                tab.addEventListener('click', () => switchTab(tab.dataset.tab));
            });
            
            // Stars
            document.querySelectorAll('.star').forEach(star => {
                star.addEventListener('click', () => {
                    currentRating = parseInt(star.dataset.rating);
                    updateStars();
                });
            });
            
            // Status buttons
            document.querySelectorAll('.status-btn').forEach(btn => {
                btn.addEventListener('click', () => {
                    currentStatus = btn.dataset.status;
                    updateStatusButtons();
                });
            });
        }
        
        function switchTab(tabName) {
            document.querySelectorAll('.tab').forEach(t => t.classList.remove('active'));
            document.querySelectorAll('.tab-content').forEach(c => c.classList.remove('active'));
            
            document.querySelector(`.tab[data-tab="${tabName}"]`).classList.add('active');
            document.getElementById(`tab-${tabName}`).classList.add('active');
        }
        
        function updateStars() {
            document.querySelectorAll('.star').forEach(star => {
                const rating = parseInt(star.dataset.rating);
                star.classList.toggle('active', rating <= currentRating);
            });
        }
        
        function updateStatusButtons() {
            document.querySelectorAll('.status-btn').forEach(btn => {
                btn.classList.toggle('active', btn.dataset.status === currentStatus);
            });
        }
        
        function renderScannedList() {
            const list = document.getElementById('scanned-books-list');
            const count = scannedBooks.length;
            
            document.getElementById('scanned-count').textContent = count;
            document.getElementById('list-count').textContent = count > 0 ? `(${count})` : '';
            
            // Show/hide export section
            document.getElementById('export-section').style.display = count > 0 ? 'block' : 'none';
            
            if (count === 0) {
                list.innerHTML = `
                    <div class="empty-state">
                        <div class="icon">üìö</div>
                        <p>No books scanned yet.<br>Start scanning to build your list!</p>
                    </div>
                `;
                return;
            }
            
            list.innerHTML = scannedBooks.map((book, index) => `
                <div class="scanned-book">
                    <div class="scanned-book-cover">
                        ${book.cover ? `<img src="${book.cover}" alt="">` : ''}
                    </div>
                    <div class="scanned-book-info">
                        <div class="title">${book.title}</div>
                        <div class="author">${book.author}</div>
                    </div>
                    <button class="export-single-btn" onclick="exportSingleBook(${index})">üì•</button>
                    <button class="remove-btn" onclick="removeBook(${index})">√ó</button>
                </div>
            `).join('');
        }
        
        function removeBook(index) {
            if (confirm('Remove this book from the list?')) {
                scannedBooks.splice(index, 1);
                saveBooks();
                renderScannedList();
            }
        }
        
        function exportSingleBook(index) {
            const book = scannedBooks[index];
            if (!book) return;
            
            const filename = `${book.title} - ${book.author}`.replace(/[\\/:*?"<>|]/g, '');
            
            let frontmatter = `---
title: "${book.title.replace(/"/g, '\\"')}"
author: "${book.author.replace(/"/g, '\\"')}"
format: physical
status: ${book.status}
rating: ${book.rating}
date_added: ${book.date_added}`;
            
            if (book.isbn) frontmatter += `\nisbn: "${book.isbn}"`;
            if (book.pages) frontmatter += `\npages: ${book.pages}`;
            if (book.publisher) frontmatter += `\npublisher: "${book.publisher.replace(/"/g, '\\"')}"`;
            if (book.published) frontmatter += `\npublished: "${book.published}"`;
            if (book.cover) frontmatter += `\ncover: "${book.cover}"`;
            if (book.categories && book.categories.length > 0) {
                frontmatter += `\ngenres: [${book.categories.map(c => `"${c}"`).join(', ')}]`;
            }
            
            frontmatter += `\nhighlight_count: 0`;
            frontmatter += `\n---\n`;
            
            let content = frontmatter;
            
            if (book.cover) {
                content += `\n![Cover](${book.cover})\n`;
            }
            
            if (book.description) {
                content += `\n## Description\n\n${book.description}\n`;
            }
            
            content += `\n## Notes\n\n`;
            if (book.notes) {
                content += `${book.notes}\n`;
            }
            
            content += `\n## Highlights\n\n`;
            
            downloadFile(filename + '.md', content);
            
            // Mark as exported visually (optional: remove from list)
            // For now just show confirmation
            alert(`‚úÖ Exported: ${book.title}`);
        }
        
        function saveBooks() {
            localStorage.setItem('scannedBooks', JSON.stringify(scannedBooks));
        }
        
        function clearAll() {
            if (confirm('Clear all scanned books? This cannot be undone.')) {
                scannedBooks = [];
                saveBooks();
                renderScannedList();
            }
        }
        
        function exportToObsidian() {
            if (scannedBooks.length === 0) {
                alert('No books to export');
                return;
            }
            
            // Generate markdown for each book
            const files = scannedBooks.map(book => {
                const filename = `${book.title} - ${book.author}`.replace(/[\\/:*?"<>|]/g, '');
                
                let frontmatter = `---
title: "${book.title.replace(/"/g, '\\"')}"
author: "${book.author.replace(/"/g, '\\"')}"
format: physical
status: ${book.status}
rating: ${book.rating}
date_added: ${book.date_added}`;
                
                if (book.isbn) frontmatter += `\nisbn: "${book.isbn}"`;
                if (book.pages) frontmatter += `\npages: ${book.pages}`;
                if (book.publisher) frontmatter += `\npublisher: "${book.publisher.replace(/"/g, '\\"')}"`;
                if (book.published) frontmatter += `\npublished: "${book.published}"`;
                if (book.cover) frontmatter += `\ncover: "${book.cover}"`;
                if (book.categories && book.categories.length > 0) {
                    frontmatter += `\ngenres: [${book.categories.map(c => `"${c}"`).join(', ')}]`;
                }
                
                frontmatter += `\nhighlight_count: 0`;
                frontmatter += `\n---\n`;
                
                let content = frontmatter;
                
                if (book.cover) {
                    content += `\n![Cover](${book.cover})\n`;
                }
                
                if (book.description) {
                    content += `\n## Description\n\n${book.description}\n`;
                }
                
                content += `\n## Notes\n\n`;
                if (book.notes) {
                    content += `${book.notes}\n`;
                }
                
                content += `\n## Highlights\n\n`;
                
                return {
                    filename: filename + '.md',
                    content: content
                };
            });
            
            // Always create ONE combined file (iOS blocks multiple downloads)
            const combined = files.map(f => 
`===============================================================================
FILE: ${f.filename}
===============================================================================

${f.content}`
            ).join('\n\n');
            
            // Add instructions at the top
            const exportContent = `# Scanned Books Export
# Generated: ${new Date().toISOString().split('T')[0]}
# Books: ${files.length}
#
# INSTRUCTIONS:
# 1. Open this file on your Mac
# 2. Run the splitter script (below) to create individual files, OR
# 3. Manually copy each section into separate .md files in your Obsidian Books folder
#
# Each book is separated by a line of === with the filename shown
#
# -------- SPLITTER SCRIPT (run on Mac) --------
# Save this as split_books.py and run: python3 split_books.py exported_file.md
#
# import re
# import sys
# from pathlib import Path
# 
# content = Path(sys.argv[1]).read_text()
# books = re.split(r'={70,}\\nFILE: (.+?)\\n={70,}\\n\\n', content)[1:]
# 
# for i in range(0, len(books), 2):
#     filename, text = books[i], books[i+1]
#     Path(filename.strip()).write_text(text.strip())
#     print(f"Created: {filename.strip()}")
# -------- END SCRIPT --------

${combined}`;
            
            downloadFile(`scanned_books_${new Date().toISOString().split('T')[0]}.md`, exportContent);
            
            alert(`‚úÖ Exported ${files.length} book(s) in one file!\n\nFind it in Files ‚Üí Downloads.\n\nTransfer to your Mac and split into individual files for Obsidian.`);
        }
        
        function downloadFile(filename, content) {
            const blob = new Blob([content], { type: 'text/markdown' });
            const url = URL.createObjectURL(blob);
            const a = document.createElement('a');
            a.href = url;
            a.download = filename;
            document.body.appendChild(a);
            a.click();
            document.body.removeChild(a);
            URL.revokeObjectURL(url);
        }
    </script>
</body>
</html>
